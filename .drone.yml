kind: pipeline
type: docker
name: drone-agents-init

steps:
- name: drone-agents-poweron
  image: walkero/hcloud:1.30
  environment:
    HCLOUD_TOKEN:
      from_secret: HCLOUD_TOKEN
  commands:
    - hcloud server poweron drone-agents

---
kind: pipeline
type: docker
name: build-images

steps:
- name: build-ppc-amigaos-sdk-image
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-sdk"
    # cache_from:
    #   - walkero/amigagccondocker:ppc-amigaos-sdk
    dockerfile: sdk/Dockerfile
    purge: true
    build_args:
      - squash
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
# - name: build-ppc-amigaos-gcc8-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-amigaos-gcc8"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-amigaos-gcc8
#     dockerfile: gcc/Dockerfile
#     purge: true
#     build_args:
#       - squash
#       - GCC_VER=8
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD
#   depends_on:
#     - build-ppc-amigaos-sdk-image
# - name: build-ppc-amigaos-gcc9-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-amigaos-gcc9"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-amigaos-gcc9
#     dockerfile: gcc/Dockerfile
#     purge: true
#     build_args:
#       - squash
#       - GCC_VER=9
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD
#   depends_on:
#     - build-ppc-amigaos-sdk-image
# - name: build-ppc-amigaos-gcc10-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-amigaos-gcc10"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-amigaos-gcc10
#     dockerfile: gcc/Dockerfile
#     purge: true
#     build_args:
#       - squash
#       - GCC_VER=10
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD
#   depends_on:
#     - build-ppc-amigaos-sdk-image
# - name: build-ppc-amigaos-gcc11-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-amigaos-gcc11"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-amigaos-gcc11
#     dockerfile: gcc/Dockerfile
#     purge: true
#     build_args:
#       - squash
#       - GCC_VER=11
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD
#   depends_on:
#     - build-ppc-amigaos-sdk-image

trigger:
  branch:
    include:
    - master
    - main
  event:
    include:
    - push

depends_on:
  - drone-agents-init

node:
  agents: builders

---
kind: pipeline
type: docker
name: drone-agents-end

steps:
- name: drone-agents-poweroff
  image: walkero/hcloud:1.30
  environment:
    HCLOUD_TOKEN:
      from_secret: HCLOUD_TOKEN
  commands:
    - hcloud server poweroff drone-agents

depends_on:
  - build-images

trigger:
  status:
    - failure
    - success

# ---
# kind: pipeline
# type: docker
# name: build-base-images

# steps:
# - name: build-gcc8-base-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-base-gcc8"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-base-gcc8
#     dockerfile: base/Dockerfile
#     build_args:
#       - GCC_VER=8
#       - MAKEFILES_PATH=base/files/native-build
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD
# - name: build-gcc9-base-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-base-gcc9"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-base-gcc9
#     dockerfile: base/Dockerfile
#     build_args:
#       - GCC_VER=9
#       - MAKEFILES_PATH=base/files/native-build
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD
# - name: build-gcc10-base-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-base-gcc10"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-base-gcc10
#     dockerfile: base/Dockerfile
#     build_args:
#       - GCC_VER=10
#       - MAKEFILES_PATH=base/files/native-build
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD

# trigger:
#   branch:
#     include:
#     - base-images
#   event:
#     include:
#     - push
