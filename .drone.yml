kind: pipeline
type: docker
name: drone-agents-init

clone:
  disable: true

steps:
- name: drone-agents-poweron
  image: walkero/hcloud:1.30
  environment:
    HCLOUD_TOKEN:
      from_secret: HCLOUD_TOKEN
  commands:
    - hcloud server poweron drone-agents

---
kind: pipeline
type: docker
name: build-images

steps:
- name: ppc-amigaos-sdk
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-sdk"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-sdk
    dockerfile: sdk/Dockerfile
    purge: true
    build_args:
      - squash
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
- name: ppc-amigaos-gcc8
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-gcc8"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-gcc8
    dockerfile: gcc/Dockerfile
    purge: true
    build_args:
      - squash
      - GCC_VER=8
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
  depends_on:
    - ppc-amigaos-sdk
- name: ppc-amigaos-gcc9
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-gcc9"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-gcc9
    dockerfile: gcc/Dockerfile
    purge: true
    build_args:
      - squash
      - GCC_VER=9
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
  depends_on:
    - ppc-amigaos-sdk
- name: ppc-amigaos-gcc10
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-gcc10"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-gcc10
    dockerfile: gcc/Dockerfile
    purge: true
    build_args:
      - squash
      - GCC_VER=10
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
  depends_on:
    - ppc-amigaos-sdk
- name: ppc-amigaos-gcc11
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-gcc11"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-gcc11
    dockerfile: gcc/Dockerfile
    purge: true
    build_args:
      - squash
      - GCC_VER=11
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
  depends_on:
    - ppc-amigaos-sdk

trigger:
  branch:
    include:
    - master
    - main
  event:
    include:
    - push

depends_on:
  - drone-agents-init

node:
  agents: builders


---
kind: pipeline
type: docker
name: build-images-newclib2

steps:
- name: ppc-amigaos-sdk-newclib2
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-sdk-newclib2"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-sdk-newclib2
    dockerfile: sdk/Dockerfile
    purge: true
    build_args:
      - squash
      - CLIB2REPO=afxgroup
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
- name: ppc-amigaos-gcc8-newclib2
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-gcc8-newclib2"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-gcc8-newclib2
    dockerfile: gcc/Dockerfile
    purge: true
    build_args:
      - squash
      - GCC_VER=8
      - CLIB2REPO=afxgroup
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
  depends_on:
    - ppc-amigaos-sdk-newclib2
- name: ppc-amigaos-gcc9-newclib2
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-gcc9-newclib2"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-gcc9-newclib2
    dockerfile: gcc/Dockerfile
    purge: true
    build_args:
      - squash
      - GCC_VER=9
      - CLIB2REPO=afxgroup
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
  depends_on:
    - ppc-amigaos-sdk-newclib2
- name: ppc-amigaos-gcc10-newclib2
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-gcc10-newclib2"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-gcc10-newclib2
    dockerfile: gcc/Dockerfile
    purge: true
    build_args:
      - squash
      - GCC_VER=10
      - CLIB2REPO=afxgroup
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
  depends_on:
    - ppc-amigaos-sdk-newclib2
- name: ppc-amigaos-gcc11-newclib2
  image: plugins/docker
  settings:
    repo: walkero/amigagccondocker
    tags:
      - "ppc-amigaos-gcc11-newclib2"
    cache_from:
      - walkero/amigagccondocker:ppc-amigaos-gcc11-newclib2
    dockerfile: gcc/Dockerfile
    purge: true
    build_args:
      - squash
      - GCC_VER=11
      - CLIB2REPO=afxgroup
    username:
      from_secret: DOCKERHUB_USERNAME
    password:
      from_secret: DOCKERHUB_PASSWORD
  depends_on:
    - ppc-amigaos-sdk-newclib2

trigger:
  branch:
    include:
    - master
    - main
  event:
    include:
    - push

depends_on:
  - drone-agents-init

node:
  agents: builders

---
kind: pipeline
type: docker
name: drone-agents-end

clone:
  disable: true

steps:
- name: drone-agents-poweroff
  image: walkero/hcloud:1.30
  environment:
    HCLOUD_TOKEN:
      from_secret: HCLOUD_TOKEN
  commands:
    - curl -sw "\n" "http://10.0.0.2:5000/container/count/drone-" | while read var1; do if [ $var1 -eq 1 ]; then hcloud server poweroff drone-agents; fi ; done

depends_on:
  - build-images

trigger:
  status:
    - failure
    - success

# ---
# kind: pipeline
# type: docker
# name: build-base-images

# steps:
# - name: build-gcc8-base-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-base-gcc8"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-base-gcc8
#     dockerfile: base/Dockerfile
#     build_args:
#       - GCC_VER=8
#       - MAKEFILES_PATH=base/files/native-build
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD
# - name: build-gcc9-base-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-base-gcc9"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-base-gcc9
#     dockerfile: base/Dockerfile
#     build_args:
#       - GCC_VER=9
#       - MAKEFILES_PATH=base/files/native-build
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD
# - name: build-gcc10-base-image
#   image: plugins/docker
#   settings:
#     repo: walkero/amigagccondocker
#     tags:
#       - "ppc-base-gcc10"
#     # cache_from:
#     #   - walkero/amigagccondocker:ppc-base-gcc10
#     dockerfile: base/Dockerfile
#     build_args:
#       - GCC_VER=10
#       - MAKEFILES_PATH=base/files/native-build
#     username:
#       from_secret: DOCKERHUB_USERNAME
#     password:
#       from_secret: DOCKERHUB_PASSWORD

# trigger:
#   branch:
#     include:
#     - base-images
#   event:
#     include:
#     - push
