# The ubuntu:latest tag points to the "latest LTS", since that's the version recommended for general use.
FROM ubuntu:latest

LABEL maintainer="Georgios Sokianos <walkero@gmail.com>"

ARG DEBIAN_FRONTEND=noninteractive
ARG GCC_VER
ARG SDK_VER
ARG REPOS_PATH
WORKDIR /tmp

RUN dpkg --add-architecture i386 && apt-get update && apt-get -y --no-install-recommends install \
    ca-certificates \
    curl \
    python2.7;

RUN ln -s /usr/bin/python2.7 /usr/bin/python; \
    curl -fsSL https://bootstrap.pypa.io/pip/2.7/get-pip.py -o /tmp/get-pip.py && \
    python get-pip.py && \
    pip2 install --no-cache-dir argcomplete==1.12.3; \
    rm -rf /tmp/* /var/tmp/*;

# Add necessary repos
ADD ${REPOS_PATH}/adtools /opt/adtools
ADD ${REPOS_PATH}/binutils-gdb /opt/adtools/binutils/repo
ADD ${REPOS_PATH}/coreutils /opt/adtools/coreutils/repo
ADD ${REPOS_PATH}/gnulib /opt/adtools/gnulib/repo

# Get custom makefiles before we compile GCC
ARG FILES_PATH
COPY ${FILES_PATH}/native-build/makefile-SDK${SDK_VER} /opt/adtools/native-build/makefile

ENV PACKAGES="autoconf \
        automake \
        autopoint \
        bison \
        dh-autoreconf \
        flex \
        g++-10 \
        gettext \
        git \
        gperf \
        libfl2 \
        libgmp-dev \
        libmpc3 \
        libmpc-dev \
        libtool \
        make \
        mc \
        nano \
        patch \
        rsync \
        texinfo \
        wget \
        xz-utils"

RUN apt-get -y --no-install-recommends install ${PACKAGES}; \
    ln -s /usr/bin/g++-10 /usr/bin/g++; \
    rm /usr/bin/gcc; \
    ln -s /usr/bin/gcc-10 /usr/bin/gcc;

# Install lha
RUN git clone https://github.com/jca02266/lha.git && \
    mkdir build && \
    cd lha || exit && \
    autoreconf -vfi && \
    cd ../build && \
    ../lha/configure --prefix=/usr && \
    make && \
    make install;

# Compile gcc
WORKDIR /opt/adtools
RUN git config --global user.email "walkero@gmail.com"; \
    git config --global user.name "Georgios Sokianos"; \
    git submodule init && \
    git submodule update && \
    gild/bin/gild checkout binutils 2.23.2 && \
    gild/bin/gild checkout gcc ${GCC_VER} && \
    make -C native-build gcc-cross CROSS_PREFIX=/opt/ppc-amigaos -j4; \
    apt -y remove ${PACKAGES} \
        curl \
        python2.7; \
    apt -y autoremove; \
    apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /opt/adtools;
